# GitHub Actions Workflow: Update URLsToGo Preview Link
#
# This workflow automatically updates a URLsToGo shortlink when a preview deployment completes.
# Works with Vercel, Cloudflare Pages, and GitHub Pages.
#
# Setup Instructions:
# 1. Copy this file to your project repo: .github/workflows/update-preview-link.yml
# 2. Add these GitHub Secrets to your repo (Settings ‚Üí Secrets ‚Üí Actions):
#    - URLSTOGO_API_KEY: Your URLsToGo API key (create at go.urlstogo.cloud/admin ‚Üí API Keys)
# 3. Customize the env variables below if needed (repo name, platform, etc.)
#
# The shortlink will be: go.urlstogo.cloud/{repo-name}--preview

name: Update Preview Link

on:
  # Trigger on any push to preview branches (not main, since that's typically production)
  push:
    branches:
      - preview
      - staging
      - 'preview/**'
      - 'feat/**'

  # Also trigger when deployments complete (works with Vercel, Cloudflare, etc.)
  deployment_status:

  # Allow manual trigger for testing
  workflow_dispatch:

env:
  # REQUIRED: Repository name (auto-detected, or customize if needed)
  REPO_NAME: ${{ github.event.repository.name }}

  # REQUIRED: Your URLsToGo domain
  URLSTOGO_DOMAIN: go.urlstogo.cloud

  # OPTIONAL: Set deployment platform (auto-detects if not set)
  # Options: vercel, cloudflare-pages, github-pages
  DEPLOYMENT_PLATFORM: auto

  # OPTIONAL: Override Cloudflare Pages project name (defaults to repo name)
  # Only needed if your CF Pages project name differs from your repo name
  # CF_PROJECT_NAME: my-custom-project

jobs:
  update-preview-link:
    name: Update Preview Link
    runs-on: ubuntu-latest

    # Only run on successful deployments or direct push events
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect deployment URL
        id: detect-url
        run: |
          DEPLOYMENT_URL=""
          PLATFORM="${{ env.DEPLOYMENT_PLATFORM }}"

          # Auto-detect platform if not specified
          if [ "$PLATFORM" = "auto" ]; then
            if [ -f "vercel.json" ] || [ -f ".vercel/project.json" ]; then
              PLATFORM="vercel"
            elif [ -f "wrangler.toml" ]; then
              PLATFORM="cloudflare-pages"
            elif [ -f ".github/workflows/pages.yml" ] || [ -f ".github/workflows/deploy-pages.yml" ]; then
              PLATFORM="github-pages"
            fi
          fi

          echo "Detected platform: $PLATFORM"

          # Slugify function (mimics Vercel/Cloudflare slugification)
          slugify() {
            echo "$1" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//'
          }

          # Get deployment URL based on platform
          case "$PLATFORM" in
            vercel)
              # For Vercel: Use deployment URL from environment or construct from branch
              if [ "${{ github.event_name }}" = "deployment_status" ]; then
                DEPLOYMENT_URL="${{ github.event.deployment_status.environment_url }}"
              else
                # Slugify repo name and branch name (Vercel converts to lowercase and replaces special chars)
                REPO_SLUG=$(slugify "${{ env.REPO_NAME }}")
                BRANCH_SLUG=$(slugify "${{ github.ref_name }}")
                OWNER_SLUG=$(slugify "${{ github.repository_owner }}")

                DEPLOYMENT_URL="https://${REPO_SLUG}-git-${BRANCH_SLUG}-${OWNER_SLUG}.vercel.app"
              fi
              ;;

            cloudflare-pages)
              # For Cloudflare Pages: Use custom project name or default to repo name
              if [ -n "${{ env.CF_PROJECT_NAME }}" ]; then
                CF_PROJECT="${{ env.CF_PROJECT_NAME }}"
              else
                CF_PROJECT=$(slugify "${{ env.REPO_NAME }}")
              fi

              BRANCH_SLUG=$(slugify "${{ github.ref_name }}")
              DEPLOYMENT_URL="https://${BRANCH_SLUG}.${CF_PROJECT}.pages.dev"
              ;;

            github-pages)
              # For GitHub Pages: Use repository URL
              OWNER_SLUG=$(slugify "${{ github.repository_owner }}")
              REPO_SLUG=$(slugify "${{ env.REPO_NAME }}")
              DEPLOYMENT_URL="https://${OWNER_SLUG}.github.io/${REPO_SLUG}"
              ;;

            *)
              echo "‚ùå Could not detect deployment platform. Please set DEPLOYMENT_PLATFORM env var."
              exit 1
              ;;
          esac

          if [ -z "$DEPLOYMENT_URL" ]; then
            echo "‚ùå Could not determine deployment URL"
            exit 1
          fi

          echo "Deployment URL: $DEPLOYMENT_URL"
          echo "url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "platform=$PLATFORM" >> $GITHUB_OUTPUT

      - name: Update URLsToGo preview link
        env:
          URLSTOGO_API_KEY: ${{ secrets.URLSTOGO_API_KEY }}
        run: |
          PREVIEW_CODE="${{ env.REPO_NAME }}--preview"
          DEPLOYMENT_URL="${{ steps.detect-url.outputs.url }}"

          echo "üìù Updating preview link: ${{ env.URLSTOGO_DOMAIN }}/${PREVIEW_CODE}"
          echo "üéØ Target URL: $DEPLOYMENT_URL"

          # Call URLsToGo API to create/update preview link
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X PUT \
            -H "Authorization: Bearer $URLSTOGO_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{\"destination\":\"$DEPLOYMENT_URL\"}" \
            "https://${{ env.URLSTOGO_DOMAIN }}/api/preview-links/${PREVIEW_CODE}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Preview link updated successfully!"
            echo ""
            echo "üîó Preview link: https://${{ env.URLSTOGO_DOMAIN }}/${PREVIEW_CODE}"
            echo "üåê Platform: ${{ steps.detect-url.outputs.platform }}"
            echo "üì¶ Deployment: $DEPLOYMENT_URL"
            echo ""
            echo "Response: $BODY"
          else
            echo "‚ùå Failed to update preview link (HTTP $HTTP_CODE)"
            echo "Response: $BODY"
            exit 1
          fi
